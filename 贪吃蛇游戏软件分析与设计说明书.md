# **贪吃蛇游戏软件分析与设计说明书**

## 1.引言

### 1.1 项目概述

​	本项目是一款基于控制台的贪吃蛇游戏，集成用户登录注册、游戏进度保存、日志记录等功能。玩家通过方向键控制蛇移动，目	标是吃掉食物得分，同时避免撞墙或咬到自己。游戏支持加速（F1）、减速（F2）、查看历史日志（F5）等功能。

###  1.2 开发环境

编程语言：C++
操作系统：Windows（依赖 Windows API 如SetConsoleCursorPosition）
集成开发环境：任意支持 C++ 的 IDE（如 Visual Studio、Code::Blocks）
编译工具：GCC 或 MSVC
依赖库：Windows API、标准 C++ 库（iostream、cstdio、cstdlib等）

## 2.系统分析

### 2.1 功能需求

#### 2.1.1 用户管理模块

 注册功能：新用户输入用户名（唯一）和密码，系统自动分配用户 ID 并存储到文件。
 登录功能：验证用户名和密码，支持错误重试。
 日志查看：显示历史游戏记录（用户 ID、用户名、开始时间、时长、得分）。

#### 2.1.2 游戏核心模块

地图渲染：绘制 56×26 的矩形边界（使用■符号）。
蛇的控制：通过方向键（↑↓←→）控制移动，禁止反向移动（如上移时不能同时下移）。
食物生成：随机生成食物（■），避免出现在蛇身位置。
碰撞检测：检测撞墙或咬到自己，触发游戏结束。
得分机制：吃掉食物得分，加速（F1）可增加得分加成。
速度调节：F1 减少移动间隔（加速），F2 增加间隔（减速）。

#### 2.1.3 日志模块

记录游戏数据：每次游戏结束时记录用户 ID、用户名、开始时间、结束时间、时长、得分。
日志存储：以文本文件（userlog.txt）存储，支持追加写入和读取显示。

### 2.2 非功能需求

界面交互：基于控制台的文本界面，坐标定位精确（使用Pos函数控制光标位置）。
性能：移动帧率通过Sleep函数控制，默认间隔 200ms，加速可低至 100ms 以下。
可维护性：模块划分清晰（用户、游戏、日志），代码结构模块化。
兼容性：仅支持 Windows 系统（依赖windows.h头文件）。

## 3.系统设计

### 3.1 架构设计

#### 3.1.1 模块划分

|   模块   |                           功能描述                           |
| :------: | :----------------------------------------------------------: |
| 用户模块 | 处理用户注册、登录、身份验证，数据存储于`users.dat`（二进制文件）。 |
| 游戏模块 | 包含地图绘制、蛇的初始化与移动、食物生成、碰撞检测、游戏循环逻辑。 |
| 日志模块 | 记录游戏日志到`userlog.txt`（文本文件），支持查看历史记录。  |
| 工具模块 | 控制台坐标定位（`Pos`函数）、工作目录初始化（`initWorkingDirectory`）。 |

#### 3.1.2 状态机设计

游戏通过枚举GameState管理状态切换：

MENU：登录 / 注册界面（loginMenu函数）。
PLAY：游戏进行中（gamestart初始化，gamecircle循环）。
EXIT：退出程序。

### 3.2 数据结构设计

#### 3.2.1 蛇的表示

结构体snake：链表节点，存储坐标（x, y）和指向下一节点的指针。

```c++
typedef struct SNAKE {
    int x, y;          // 坐标（x为偶数，确保与地图边界对齐）
    struct SNAKE* next; // 下一节点指针
} snake;
```

链表操作：头节点为蛇头，后续节点为身体，移动时新增头节点，未吃到食物时删除尾节点。

#### 3.2.2 用户数据：

结构体User：存储用户 ID、用户名、密码。

```c
typedef struct {
    int id;             // 用户ID（自动递增）
    char username[32];  // 用户名（最大31字符）
    char password[32];  // 密码（最大31字符）
} User;
```

存储方式：二进制文件users.dat，每个用户占固定长度（sizeof(User)），注册时追加写入。

#### 3.2.3 日志数据

存储格式：文本文件userlog.txt，每行格式为：
用户ID, 用户名, 开始时间, 结束时间, 时长(s), 得分4. 模块详细设计

## 4. 模块详细设计

### 4.1 用户模块

#### 4.1.1 注册功能（`registerUser`函数）

输入：用户名、密码（均限制 31 字符）。

处理逻辑：

1. 检查用户名是否已存在（遍历`users.dat`）。
2. 生成新用户 ID（文件中用户数 + 1）。
3. 将用户数据追加写入`users.dat`。

输出：注册成功 / 失败提示。

#### 4.1.2 登录功能（`authenticateUser`函数）

输入：用户名、密码。

处理逻辑：遍历`users.dat`，匹配用户名和密码。

输出：登录成功（返回 1）或失败（返回 0）。

### 4.2 游戏模块

#### 4.2.1 地图绘制（`creatMap`函数）

边界：上下边界为水平线段（56 宽，0 和 26 行），左右边界为垂直线段（26 高，0 和 56 列）。

绘制字符：使用`■`（ASCII 码 219）表示边界。

#### 4.2.2 蛇初始化（`initsnake`函数）

初始状态：4 节身体，横向排列（坐标`(24+2i, 5)`，`i=0~3`）。

绘制方式：遍历链表，在每个节点坐标绘制`■`。

#### 4.2.3 食物生成（`createfood`函数）

随机范围：x∈[2, 54]（偶数，步长 2），y∈[1, 25]。

碰撞检测：确保食物不在蛇身位置（遍历链表检查坐标）。

#### 4.2.4 蛇移动（`snakemove`函数）

输入：当前移动方向（`status`，枚举`U/D/L/R`）。

处理逻辑：

1. 计算新蛇头坐标，检测撞墙（返回 1）。
2. 创建新头节点，连接到链表头部。
3. 若吃到食物：保留所有节点，重新生成食物；否则删除尾节点。
4. 检测咬到自己（遍历链表，头节点与身体节点坐标匹配，返回 2）。

输出：碰撞原因（0 = 正常，1 = 撞墙，2 = 咬到自己）。

#### 4.2.5 游戏循环（`gamecircle`函数）

输入处理：异步检测键盘输入（`GetAsyncKeyState`），支持方向键、F1/F2（调速）、F5（日志）、ESC（退出）。

刷新逻辑：通过`Sleep(sleeptime)`控制移动速度，默认 200ms，F1 减 50ms（最小 100ms），F2 加 50ms（无上限）。

### 4.3 日志模块

#### 4.3.1 写入日志（`writeUserLog`函数）

数据采集：游戏开始时间（`game_start_time`）、结束时间、时长（`difftime`计算）、格式化时间字符串（`strftime`）。

存储方式：追加写入`userlog.txt`，每行一个日志条目。

#### 4.3.2 查看日志（`showUserLogs`函数）

读取逻辑：逐行读取`userlog.txt`，格式化输出到控制台。

## 5. 数据存储设计

### 5.1 用户数据存储（`users.dat`）

文件类型：二进制文件，随机访问。

结构：每个用户占固定长度（`sizeof(User)=4+32+32=68字节`）。

操作：

​	注册：追加写入新用户结构体。

​	登录：遍历文件查找匹配的用户名和密码。

### 5.2 日志数据存储（`userlog.txt`）

文件类型：文本文件，顺序访问。

编码：ANSI 编码（默认控制台编码）。

格式：逗号分隔值（CSV），便于文本编辑和解析。

## 6. 界面设计

### 6.1 控制台布局

| 区域         | 坐标范围            | 内容描述                                                     |
| ------------ | ------------------- | ------------------------------------------------------------ |
| **游戏地图** | x: 0~56, y: 0~26    | 边界`■`，蛇和食物用`■`表示，背景为空格。                     |
| **右侧信息** | x: 64~100, y: 10~26 | 显示得分、操作提示（如 “↑↓←→控制移动”）、用户状态（“***用户正在游戏中***”）。 |
| **底部提示** | y: 28               | 当前登录用户提示（如 “***player1 正在游戏中***”）。          |

### 6.2 交互设计

方向控制：↑↓←→控制移动，禁止反向（如上移时不能同时下移）。

功能键：

- F1：加速（`sleeptime -= 50`，最小 100ms）。
- F2：减速（`sleeptime += 50`）。
- F5：查看日志（暂停游戏，清屏显示日志）。
- ESC：退出游戏（返回菜单）。
- SPACE：未实现暂停功能（代码注释提及但未实现）。

## 7. 算法设计

### 7.1 碰撞检测算法

撞墙检测：新蛇头坐标是否在边界外（`x ≤ 0`、`x ≥ 56`、`y ≤ 0`、`y ≥ 26`）。

咬到自己：遍历蛇身链表，检查新蛇头是否与任一身体节点坐标相同。

### 7.2 食物生成算法

随机数生成：基于时间种子（`srand(time(NULL))`），生成符合地图范围的坐标。

冲突检测：使用 Lambda 表达式遍历蛇身，确保食物坐标不与蛇身重叠。

## 8. 测试计划

### 8.1 单元测试

| 模块         | 测试用例              | 预期结果                 |
| ------------ | --------------------- | ------------------------ |
| **用户注册** | 重复用户名注册        | 提示 “用户名已存在”      |
| **登录验证** | 正确用户名 + 错误密码 | 登录失败                 |
| **蛇移动**   | 向上移动时按下向下键  | 方向不变（禁止反向）     |
| **食物生成** | 多次生成食物          | 食物不在蛇身位置         |
| **日志记录** | 游戏结束后查看日志    | 日志包含正确的时长和得分 |

### 8.2 集成测试

流程测试：注册→登录→开始游戏→加速得分→撞墙结束→查看日志，验证各模块协作正常。

边界测试：蛇移动到地图边缘（x=2, y=1）、最大速度（sleeptime=100ms）、最长蛇身（填满地图）。

## 9. 系统缺陷与改进建议

### 9.1 已知缺陷

密码安全：密码以明文存储，未加密（可通过哈希算法改进）。

暂停功能：代码注释提及 SPACE 暂停，但实际未实现。

文件锁：多用户同时操作`users.dat`可能导致数据损坏（需添加文件锁机制）。

地图大小：硬编码为 56×26，不支持动态调整。

### 9.2 改进方向

数据存储：改用数据库（如 SQLite）存储用户和日志，提升数据管理效率。

界面优化：使用图形库（如 SFML）替代控制台，实现更丰富的视觉效果。

网络功能：添加排行榜、多人联机模式（需网络编程支持）。

错误处理：完善文件操作的错误处理（如磁盘空间不足、权限拒绝）。

## 10. 总结

​	本贪吃蛇游戏实现了基础的用户管理、游戏逻辑和日志记录功能，模块划分清晰，代码结构合理。通过控制台界面提供交互，适合单人休闲娱乐。未来可通过优化存储、增强界面和添加网络功能提升可玩性和扩展性。